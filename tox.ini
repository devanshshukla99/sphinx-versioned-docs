[tox]
envlist =
    py{38,39,310}
    legacy_build
    codestyle
    docs
    sphinx_rtd_theme
    astropy_sphinx_theme
    alabaster
requires =
    setuptools >= 58.1.0
    pip >= 23.0.1
isolated_build = true

# test coverage
# test a multi-commit repository with `sphinx_rtd_theme` and injection tests
[testenv]
changedir = .tmp/{envname}
description = build `sphinx_rtd_theme` with prebuild for a multi-commit git-repo
extras = tests
deps = sphinx_rtd_theme
commands =
    python {toxinidir}/tests/cleanup.py
    - sphinx-quickstart docs -p test-sphinx -a devanshshukla99 -v v1.0 --makefile --no-sep -r v1.0 -l en -q
    python {toxinidir}/tests/prepare_multicommit_repo.py sphinx_rtd_theme
    sphinx-versioned --no-quite --log=debug
    pytest {toxinidir}/tests/test_multicommit_injection.py --verbose --tb=short {posargs}

# test against sphinx_rtd_theme with prebuild
[testenv:legacy_build]
changedir = .tmp/{envname}
description = build `sphinx_rtd_theme` with prebuild
extras = tests
deps = sphinx_rtd_theme
commands =
    python {toxinidir}/tests/cleanup.py
    - sphinx-quickstart docs -p test-sphinx -a devanshshukla99 -v v1.0 --makefile --no-sep -r v1.0 -l en -q
    python {toxinidir}/tests/prepare_tox_build_docs.py sphinx_rtd_theme
    sphinx-versioned --no-quite --log=debug
    pytest {toxinidir}/tests/test_injection.py --verbose --tb=short {posargs}

# test codestyle
[testenv:codestyle]
changedir =
skip_install = true
description = check code style
deps = 
    black
commands =
    black --color --diff --check {toxinidir}

# test docs build
[testenv:docs]
changedir = docs
description = invoke sphinx-build to build the HTML docs
extras = docs
commands =
    sphinx-build -W -b html . _build/html

# test themes
[testenv:sphinx_rtd_theme]
changedir = .tmp/{envname}
description = test sphinx_rtd_theme with --no-prebuild and main branch
extras = tests
deps = sphinx_rtd_theme
commands =
    python {toxinidir}/tests/cleanup.py
    - sphinx-quickstart docs -p test-sphinx -a devanshshukla99 -v v1.0 --makefile --no-sep -r v1.0 -l en -q
    python {toxinidir}/tests/prepare_multicommit_repo.py sphinx_rtd_theme
    sphinx-versioned --no-quite --log=debug
    pytest {toxinidir}/tests/test_multicommit_injection.py --verbose --tb=short {posargs}

[testenv:astropy_sphinx_theme]
changedir = .tmp/{envname}
description = test astropy_sphinx_theme with --no-prebuild and main branch
extras = tests
deps = astropy_sphinx_theme
commands =
    python {toxinidir}/tests/cleanup.py
    - sphinx-quickstart docs -p test-sphinx -a devanshshukla99 -v v1.0 --makefile --no-sep -r v1.0 -l en -q
    python {toxinidir}/tests/prepare_multicommit_repo.py bootstrap-astropy
    sphinx-versioned --no-quite --log=debug
    pytest {toxinidir}/tests/test_multicommit_injection.py --verbose --tb=short {posargs}

[testenv:alabaster]
changedir = .tmp/{envname}
description = test alabaster with --no-prebuild and main branch
extras = tests
commands =
    python {toxinidir}/tests/cleanup.py
    - sphinx-quickstart docs -p test-sphinx -a devanshshukla99 -v v1.0 --makefile --no-sep -r v1.0 -l en -q
    python {toxinidir}/tests/prepare_multicommit_repo.py alabaster
    sphinx-versioned --no-quite --log=debug
    pytest {toxinidir}/tests/test_multicommit_injection.py --verbose --tb=short {posargs}
